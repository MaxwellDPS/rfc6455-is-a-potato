# Define a map block to set the $connection_upgrade variable based on the value of $http_upgrade.
# This helps to manage WebSocket connections by upgrading or closing the connection as needed.
map $http_upgrade $connection_upgrade {
    default      upgrade; # If $http_upgrade has any value, set $connection_upgrade to "upgrade".
    ''           close;   # If $http_upgrade is empty, set $connection_upgrade to "close".
}

# Define an upstream block named 'headscale' that points to the backend server 'headscale' running on port 8080.
upstream headscale {
    server headscale:8080;
}

# Define another upstream block named 'rfc6455-proxy' that points to the backend server 'rfc6455-proxy' running on port 9000.
upstream rfc6455-proxy {
    server rfc6455-proxy:9000;
}

# Begin defining a server block for the Nginx configuration.
server {
    listen 80;           # Listen on port 80 for IPv4.
    listen [::]:80;      # Listen on port 80 for IPv6.

    server_name _; # Use a wildcard server name to match any server name.

    # Define a location block for the /ts2021 endpoint.
    location /ts2021 {
        proxy_pass http://rfc6455-proxy; # Pass requests to the rfc6455-proxy upstream defined earlier.
        proxy_http_version 1.1;          # Use HTTP/1.1 for proxying.
        proxy_set_header Host $host;     # Set the Host header to the value of $host.
        proxy_set_header X-Real-IP $remote_addr; # Set the X-Real-IP header to the client's IP address.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Add the client's IP to the X-Forwarded-For header.
        proxy_set_header X-Forwarded-Proto $scheme; # Set the X-Forwarded-Proto header to the request's scheme (http or https).
        proxy_set_header Upgrade $http_upgrade;    # Set the Upgrade header to the value of $http_upgrade for WebSocket support.
        proxy_set_header Connection "upgrade";     # Set the Connection header to "upgrade" for WebSocket support.
    }

    # # Define a location block for all other endpoints.
    # location / {
    #     proxy_pass http://headscale; # Pass requests to the specified backend server.
    #     proxy_http_version 1.1;      # Use HTTP/1.1 for proxying.
    #     proxy_set_header Upgrade $http_upgrade;  # Set the Upgrade header to the value of $http_upgrade for WebSocket support.
    #     proxy_set_header Connection $connection_upgrade; # Set the Connection header based on the value of $connection_upgrade.
    #     proxy_set_header Host $server_name;      # Set the Host header to the server's name.
    #     proxy_redirect http:// https://;         # Redirect HTTP to HTTPS.
    #     proxy_buffering off;                     # Disable response buffering.
    #     proxy_set_header X-Real-IP $remote_addr; # Set the X-Real-IP header to the client's IP address.
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Add the client's IP to the X-Forwarded-For header.
    #     proxy_set_header X-Forwarded-Proto $scheme; # Set the X-Forwarded-Proto header to the request's scheme (http or https).
    #     # Add a Strict-Transport-Security header to enforce HTTPS for 180 days and include subdomains.
    #     add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
    # }

    # Define a location block for the /metrics endpoint.
    location /metrics {
        stub_status; # Enable Nginx stub status module to expose basic status information.
    }
}



# Begin defining a server block for the TLS Nginx configuration.
server {
    listen 443      ssl http2; # Listen on port 443 for IPv4 with SSL and HTTP/2.
    listen [::]:443 ssl http2; # Listen on port 443 for IPv6 with SSL and HTTP/2.

    server_name _; # Use a wildcard server name to match any server name.

    # Define SSL certificate and key file locations.
    ssl_certificate <PATH_TO_CERT>;
    ssl_certificate_key <PATH_CERT_KEY>;

    # Specify the SSL protocols to use.
    ssl_protocols TLSv1.2 TLSv1.3;

    # Define a location block for all other endpoints.
    location / {
        proxy_pass http://headscale; # Pass requests to the specified backend server.
        proxy_http_version 1.1;      # Use HTTP/1.1 for proxying.
        proxy_set_header Upgrade $http_upgrade;  # Set the Upgrade header to the value of $http_upgrade for WebSocket support.
        proxy_set_header Connection $connection_upgrade; # Set the Connection header based on the value of $connection_upgrade.
        proxy_set_header Host $server_name;      # Set the Host header to the server's name.
        proxy_redirect http:// https://;         # Redirect HTTP to HTTPS.
        proxy_buffering off;                     # Disable response buffering.
        proxy_set_header X-Real-IP $remote_addr; # Set the X-Real-IP header to the client's IP address.
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Add the client's IP to the X-Forwarded-For header.
        proxy_set_header X-Forwarded-Proto $scheme; # Set the X-Forwarded-Proto header to the request's scheme (http or https).
        # Add a Strict-Transport-Security header to enforce HTTPS for 180 days and include subdomains.
        add_header Strict-Transport-Security "max-age=15552000; includeSubDomains" always;
    }

}
